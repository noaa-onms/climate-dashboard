---
title: "`r params$sanctuary`"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    self_contained: false
    lib_dir: "docs/libs"
    includes:
      in_header: "./_navbar.html"
    css: "_style.css"
params:
  nms: "CBNMS"
  sanctuary: "Cordell Bank"
editor_options: 
  chunk_output_type: console
---

```{r setup}
# params <- list(
#   nms       = "CBNMS",
#   sanctuary = "Cordell Bank")

librarian::shelf(
  dplyr, glue, here, mapview, readr, sf, stringr,
  marinebon/extractr)
# devtools::load_all("~/Github/marinebon/extractr")
source(here("scripts/functions.R"))

sanctuaries <- readRDS(here("data/sanctuaries.rds"))
datasets <- read_csv(here("data/datasets.csv"))
# TODO: add y_label, âˆ† height CRW_SST

write_metadata <- function(
    sanctuary_nms, dataset_var, dataset_url,
    prefix = "", suffix = ""){

  cat(glue('
  <details>
  <summary><span style="color: #737373; font-size: 12px">Metadata</span></summary>
  {prefix}
  The ERDDAP dataset for [{dataset_var}]({dataset_url}) was extracted using [get_data.R](https://github.com/noaa-onms/climate-dashboard/blob/main/scripts/get_data.R) for the {params$sanctuary} polygon and output to [{params$nms}.csv](https://raw.githubusercontent.com/noaa-onms/climate-dashboard/main/data/{dataset_var}/{params$nms}.csv), which gets visualized below using [`extractr::plot_ts()`](https://marinebon.github.io/extractr/reference/plot_ts.html).
  {suffix}
  </details> 
  '))
}
```

# Map {.sidebar data-width=200}

```{r}
sanctuaries |>
  filter(sanctuary == params$sanctuary) |>
  map_sanctuary()
```

# Climatological

### Sea Surface Temperature {data-height=300}

```{r, results='asis'}
ds_var <- "sst"
ds <- filter(datasets, var == !!ds_var)
write_metadata(params$nms, ds_var, ds$url)
```
    
```{r}
ts_csv <- here(glue("data/{ds_var}/{params$nms}.csv"))
plot_ts(ts_csv, fld_sd = "sd", color = ds$plot_color, label = ds$plot_label)
```

### Chlorophyll {data-height=300}
    
```{r, results='asis'}
ds_var <- "chlorophyll"
ds <- filter(datasets, var == !!ds_var)
write_metadata(params$nms, ds_var, ds$url)
```

```{r}
ts_csv <- here(glue("data/{ds_var}/{params$nms}.csv"))
plot_ts(ts_csv, fld_sd = "sd", color = ds$plot_color, label = ds$plot_label)
```

### Coral Reef Watch {data-height=300}

```{r, results='asis'}
ds_var <- "CRW_SST"
ds <- filter(datasets, var == !!ds_var)

pfx <- '
  <details>
  <summary>
  <span style="color: #dc3545;font-size: 12px">Dataset Incomplete</span></summary>
  Only the first of the year for this daily dataset was consistently fetched across sanctuaries so far.
  </details>'
write_metadata(params$nms, ds_var, ds$url, pfx)
```



```{r}
ts_csv <- here(glue("data/{ds_var}/{params$nms}.csv"))
plot_ts(ts_csv, fld_sd = "sd", color = ds$plot_color, label = ds$plot_label)
```

# Physical-chemical

### Chart P.1

```{r}
```

### Chart P.2

```{r}
```


# Biological

### Chart B.1

```{r}
```

### Chart B.2

```{r}
```

# Human Dimensions

### Chart H.1

```{r}
```

### Chart H.2

```{r}
```

